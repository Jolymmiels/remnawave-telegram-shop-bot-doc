---
title: Мониторинг и проверки здоровья
description: Мониторинг статуса бота и проверки здоровья
---

## Конечная точка проверки здоровья

Бот предоставляет конечную точку мониторинга на настроенном порту.

```bash
curl http://your-bot:8080/healthcheck
```

### Ответ

**Здоров (200 OK):**
```json
{
  "status": "ok",
  "version": "3.4.1",
  "commit": "abc123",
  "buildDate": "2024-11-10"
}
```

**Ошибка (500 Error):**
```json
{
  "status": "error",
  "message": "database connection failed"
}
```

## Что проверяется

1. **База данных** - Подключение к PostgreSQL
2. **Панель Remnawave** - Доступность API
3. **Служба бота** - Процесс запущен
4. **API ключ** - Учётные данные действительны

## Настройка мониторинга

### Проверка здоровья Docker Compose

Уже настроена в `docker-compose.yaml`:

```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:8080/healthcheck"]
  interval: 30s
  timeout: 10s
  retries: 3
```

### Ручной мониторинг

Регулярно проверяйте статус:

```bash
# Проверить сейчас
curl -s http://localhost:8080/healthcheck | jq

# Проверить каждую минуту
watch -n 60 'curl -s http://localhost:8080/healthcheck | jq'

# Записать результаты
while true; do
  echo "$(date): $(curl -s http://localhost:8080/healthcheck)"
  sleep 60
done >> /var/log/bot-health.log
```

### Внешний мониторинг

**Uptime Robot** (рекомендуется):
1. Перейдите на [uptimerobot.com](https://uptimerobot.com)
2. Добавьте HTTP монитор
3. URL: `https://bot.example.com/healthcheck`
4. Интервал: 5 минут
5. Получайте оповещения об отказах

**Grafana + Prometheus**:
- Скрейпируйте конечную точку каждые 30 сек
- Создавайте дашборды
- Устанавливайте оповещения

## Логи и отладка

### Просмотр логов

```bash
# Текущие логи
docker compose logs remnawave-telegram-shop-bot

# Следить за логами (в реальном времени)
docker compose logs -f remnawave-telegram-shop-bot

# Последние N строк
docker compose logs --tail 100 remnawave-telegram-shop-bot

# Определённый диапазон времени
docker compose logs --since 2024-11-10T10:00:00 --until 2024-11-10T11:00:00 remnawave-telegram-shop-bot
```

### Логи БД

```bash
docker compose logs -f postgres
```

### Фильтрация логов

```bash
# Только ошибки
docker compose logs remnawave-telegram-shop-bot | grep ERROR

# Связанные с платежами
docker compose logs remnawave-telegram-shop-bot | grep -i payment

# Конкретный пользователь
docker compose logs remnawave-telegram-shop-bot | grep "user_id:123456789"
```

## Ключевые метрики для контроля

| Метрика | Здорово | Предупреждение | Критично |
|---------|---------|---|----------|
| Время отклика | < 100ms | 100-500ms | > 500ms |
| Уровень ошибок | < 1% | 1-5% | > 5% |
| Использование CPU | < 50% | 50-80% | > 80% |
| Память | < 500MB | 500-1GB | > 1GB |
| Подключения БД | < 10 | 10-20 | > 20 |

## Оптимизация производительности

### Оптимизация БД

```sql
-- Проверьте медленные запросы
EXPLAIN ANALYZE SELECT * FROM subscriptions WHERE user_id = 123;

-- Создайте индексы при необходимости
CREATE INDEX idx_subscriptions_user_id ON subscriptions(user_id);

-- Проверьте раздутость
SELECT * FROM pg_stat_user_tables WHERE n_dead_tup > 1000;
```

### Масштабирование бота

- Несколько экземпляров за балансировщик нагрузки
- Репликация БД
- Слой кэширования (Redis)
- CDN для статического контента

## Настройка оповещений

### Email оповещения

```bash
# В crontab
*/5 * * * * /usr/local/bin/check-bot-health.sh

#!/bin/bash
if ! curl -s http://localhost:8080/healthcheck | grep -q "ok"; then
  echo "Bot is down!" | mail -s "Alert: Bot Down" admin@example.com
fi
```

### Уведомления в Telegram

```bash
# Отправить оповещение администратору
curl -X POST https://api.telegram.org/bot<TOKEN>/sendMessage \
  -d "chat_id=<ADMIN_ID>" \
  -d "text=Bot health check failed"
```

## Устранение неполадок нездорового бота

1. **Проверьте процесс**
   ```bash
   docker compose ps
   docker compose logs -f
   ```

2. **Проверьте БД**
   ```bash
   docker compose exec postgres psql -U remnawave -d remnawave -c "SELECT 1"
   ```

3. **Проверьте Remnawave**
   ```bash
   curl https://your-panel.com/health
   ```

4. **Перезагрузитесь при необходимости**
   ```bash
   docker compose restart remnawave-telegram-shop-bot
   ```

5. **Полная перезагрузка**
   ```bash
   docker compose down
   docker compose up -d
   docker compose logs -f
   ```

## Окна обслуживания

Планируйте обслуживание в часы низкой нагрузки:
- 2-4 AM локальное время
- Обновление образов Docker
- Обслуживание БД
- Резервная копия данных
- Тестирование восстановления
